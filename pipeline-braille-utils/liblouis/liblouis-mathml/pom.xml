<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  
  <modelVersion>4.0.0</modelVersion>
  
  <parent>
    <groupId>org.daisy.pipeline.modules.braille</groupId>
    <artifactId>braille-modules-parent</artifactId>
    <version>1.8-SNAPSHOT</version>
    <relativePath>../../../parent/</relativePath>
  </parent>
  
  <groupId>org.daisy.pipeline.modules.braille</groupId>
  <artifactId>liblouis-mathml</artifactId>
  <version>1.1.1-SNAPSHOT</version>
  <packaging>bundle</packaging>
  
  <name>DAISY Pipeline 2 Braille Module :: liblouis-mathml</name>
  
  <build>
    <resources>
      <resource>
        <directory>src/main/resources</directory>
      </resource>
      <resource>
        <directory>target/generated-resources</directory>
      </resource>
    </resources>
    <plugins>
      <plugin>
        <artifactId>maven-scm-plugin</artifactId>
        <version>1.8.1</version>
        <executions>
          <execution>
            <id>checkout-tables</id>
            <phase>generate-sources</phase>
            <goals>
              <goal>checkout</goal>
            </goals>
            <configuration>
              <connectionUrl>scm:svn:http://liblouis.googlecode.com/svn/trunk/tables</connectionUrl>
              <scmVersion>895</scmVersion>
              <scmVersionType>revision</scmVersionType>
              <checkoutDirectory>target/checkout/liblouis/tables/</checkoutDirectory>
              <skipCheckoutIfExists>true</skipCheckoutIfExists>
            </configuration>
          </execution>
          <execution>
            <id>checkout-lbu_files</id>
            <phase>generate-sources</phase>
            <goals>
              <goal>checkout</goal>
            </goals>
            <configuration>
              <connectionUrl>scm:hg:https://code.google.com/p/liblouisutdml/</connectionUrl>
              <scmVersion>c94917dab530</scmVersion>
              <scmVersionType>tag</scmVersionType>
              <checkoutDirectory>target/checkout/liblouisutdml/</checkoutDirectory>
              <skipCheckoutIfExists>true</skipCheckoutIfExists>
              <includes>
                lbu_files/marburg.sem,
                lbu_files/nemeth.sem,
                lbu_files/ukmaths.sem
              </includes>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <!-- WARNING: *nix only-->
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>shell-maven-plugin</artifactId>
        <configuration>
          <chmod>true</chmod>
        </configuration>
        <executions>
          <execution>
            <id>filter-math-files</id>
            <phase>process-sources</phase>
            <goals>
              <goal>shell</goal>
            </goals>
            <configuration>
              <workDir>target</workDir>
              <script>
                #!/bin/bash
                TABLES=(
                    unicode.dis
                    braille-patterns.cti
                    marburg.ctb
                    marburg_edit.ctb
                    nemeth.ctb
                    nemeth_edit.ctb
                    ukmaths.ctb
                    ukmaths_edit.ctb
                    wiskunde.ctb)
                SEM_FILES=(
                    marburg.sem
                    nemeth.sem
                    ukmaths.sem)
                table_dependencies() {
                    DEPENDENCIES=$(grep -E "^include.*" checkout/liblouis/tables/$1 | sed 's/^include  *\([^ ][^ ]*\).*$/\1/')
                    TRANSITIVE_DEPENDENCIES=""
                    for TABLE in $DEPENDENCIES; do
                        TRANSITIVE_DEPENDENCIES="$TRANSITIVE_DEPENDENCIES $(table_dependencies $TABLE)"
                    done
                    echo "$DEPENDENCIES $TRANSITIVE_DEPENDENCIES"
                }
                mkdir -p generated-resources/lbu_files
                for FILE in ${SEM_FILES[@]}; do
                    cp checkout/liblouisutdml/lbu_files/$FILE generated-resources/lbu_files/
                done
                ALL_TABLES=""
                for TABLE in ${TABLES[@]}; do
                    ALL_TABLES="$TABLE $ALL_TABLES $(table_dependencies $TABLE)"
                done
                ALL_TABLES="$(echo $ALL_TABLES | tr ' ' '\n' | sort | uniq)"
                for TABLE in ${ALL_TABLES[@]}; do
                    cp checkout/liblouis/tables/$TABLE generated-resources/lbu_files/
                done
              </script>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.apache.felix</groupId>
        <artifactId>maven-bundle-plugin</artifactId>
        <configuration>
          <instructions>
            <Import-Package>*, org.daisy.pipeline.braille.liblouis</Import-Package>
            <Service-Component>OSGI-INF/liblouis-mathml-config.xml</Service-Component>
          </instructions>
        </configuration>
      </plugin>
    </plugins>
  </build>
  
</project>
